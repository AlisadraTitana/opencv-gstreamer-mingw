name: Build OpenCV with GStreamer (Python 3.9.2)

on:
  workflow_dispatch:

jobs:
  build-opencv:
    runs-on: windows-latest

    steps:
      - name: Checkout OpenCV source
        run: |
          git clone https://github.com/opencv/opencv.git
          git clone https://github.com/opencv/opencv_contrib.git

      - name: Install dependencies
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
          choco install ninja -y
          choco install python --version=3.9.2 -y
          choco install gstreamer gstreamer-devel -y
          refreshenv

      - name: Configure build with CMake
        run: |
          mkdir build
          cd build
          cmake -G "Ninja" ^
            -D CMAKE_BUILD_TYPE=Release ^
            -D BUILD_opencv_world=ON ^
            -D BUILD_opencv_python3=ON ^
            -D WITH_GSTREAMER=ON ^
            -D BUILD_EXAMPLES=OFF ^
            -D BUILD_TESTS=OFF ^
            -D BUILD_PERF_TESTS=OFF ^
            -D OPENCV_EXTRA_MODULES_PATH=../opencv_contrib/modules ^
            -D CMAKE_INSTALL_PREFIX=install ^
            -D PYTHON_EXECUTABLE="C:/Python39/python.exe" ^
            ../opencv

      - name: Build OpenCV
        run: |
          cd build
          cmake --build . --config Release --target install

      - name: Locate built cv2.pyd
        id: findpyd
        shell: pwsh
        run: |
          $pyd = Get-ChildItem -Path build -Recurse -Filter "cv2.pyd" | Select-Object -First 1
          echo "Found: $($pyd.FullName)"
          echo "pyd_path=$($pyd.FullName)" >> $env:GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cv2_pyd_gstreamer_python39
          path: ${{ steps.findpyd.outputs.pyd_path }}
