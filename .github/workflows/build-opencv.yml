name: Build OpenCV with GStreamer (Windows)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    env:
      OPENCV_VERSION: 4.10.0
      PYTHON_VERSION: 3.10
      GSTREAMER_VERSION: 1.22.8

    steps:
    # -----------------------------
    # Checkout
    # -----------------------------
    - name: Checkout
      uses: actions/checkout@v4

    # -----------------------------
    # Setup Python
    # -----------------------------
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Upgrade pip and install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy wheel

    # -----------------------------
    # Install GStreamer
    # -----------------------------
    - name: Install GStreamer
      run: |
        curl -L -o gstreamer.msi https://gstreamer.freedesktop.org/data/pkg/windows/1.22.8/msvc/gstreamer-1.0-msvc-x86_64-1.22.8.msi
        curl -L -o gstreamer-dev.msi https://gstreamer.freedesktop.org/data/pkg/windows/1.22.8/msvc/gstreamer-1.0-devel-msvc-x86_64-1.22.8.msi
        msiexec /i gstreamer.msi /quiet /norestart
        msiexec /i gstreamer-dev.msi /quiet /norestart

    - name: Add GStreamer to PATH
      run: echo "C:\gstreamer\1.0\msvc_x86_64\bin" >> $env:GITHUB_PATH

    # -----------------------------
    # Clone OpenCV
    # -----------------------------
    - name: Clone OpenCV
      run: |
        git clone https://github.com/opencv/opencv.git
        git clone https://github.com/opencv/opencv_contrib.git
        cd opencv
        git checkout ${{ env.OPENCV_VERSION }}
        cd ../opencv_contrib
        git checkout ${{ env.OPENCV_VERSION }}

    # -----------------------------
    # Configure OpenCV
    # -----------------------------
    - name: Configure OpenCV
      run: |
        mkdir opencv\build
        cd opencv\build
        cmake -G "Visual Studio 17 2022" -A x64 `
          -D CMAKE_BUILD_TYPE=Release `
          -D CMAKE_INSTALL_PREFIX=install `
          -D OPENCV_EXTRA_MODULES_PATH=..\..\opencv_contrib\modules `
          -D BUILD_opencv_python3=ON `
          -D PYTHON3_EXECUTABLE=python `
          -D WITH_GSTREAMER=ON `
          -D WITH_FFMPEG=ON `
          -D OPENCV_ENABLE_NONFREE=ON `
          -D BUILD_EXAMPLES=OFF `
          -D BUILD_TESTS=OFF `
          -D BUILD_PERF_TESTS=OFF `
          -D GSTREAMER_DIR="C:\gstreamer\1.0\msvc_x86_64" `
          ..

    # -----------------------------
    # Build OpenCV
    # -----------------------------
    - name: Build OpenCV
      run: |
        cd opencv\build
        cmake --build . --config Release --parallel

    # -----------------------------
    # Install OpenCV
    # -----------------------------
    - name: Install OpenCV
      run: |
        cd opencv\build
        cmake --install . --config Release

    # -----------------------------
    # Install Python bindings (cv2)
    # -----------------------------
    - name: Build and install cv2 Python module
      run: |
        cd opencv\build\python
        python setup.py bdist_wheel
        pip install dist\*.whl

    # -----------------------------
    # Verify installation
    # -----------------------------
    - name: Verify OpenCV + GStreamer
      run: |
        python - <<EOF
        import cv2
        print("OpenCV version:", cv2.__version__)
        print("GStreamer support:", "YES" if "GStreamer" in cv2.getBuildInformation() else "NO")
        EOF
