name: Build OpenCV with GStreamer + MinGW

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSYS2 + Install GStreamer + unzip
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          base-devel
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-python
          mingw-w64-x86_64-python-pip
          mingw-w64-x86_64-gstreamer
          mingw-w64-x86_64-gst-plugins-base
          mingw-w64-x86_64-gst-plugins-good
          mingw-w64-x86_64-gst-plugins-bad
          mingw-w64-x86_64-gst-plugins-ugly
          mingw-w64-x86_64-gst-libav
          mingw-w64-x86_64-gst-devtools
          unzip

    - name: Download OpenCV + Contrib
      run: |
        curl -L -o opencv.zip https://github.com/opencv/opencv/archive/4.10.0.zip
        curl -L -o opencv_contrib.zip https://github.com/opencv/opencv_contrib/archive/4.10.0.zip
        unzip -q opencv.zip
        unzip -q opencv_contrib.zip
        mv opencv-4.10.0 opencv
        mv opencv_contrib-4.10.0 opencv_contrib

    - name: Configure Python paths
      run: |
        PYTHON_EXEC=$(which python)
        PYTHON_INC=$(python -c "import distutils.sysconfig; print(distutils.sysconfig.get_python_inc())")
        PYTHON_LIB_DIR=$(python -c "import distutils.sysconfig; print(distutils.sysconfig.get_python_lib(plat_specific=1))")
        echo "PYTHON_EXEC=$PYTHON_EXEC" >> $GITHUB_ENV
        echo "PYTHON_INC=$PYTHON_INC" >> $GITHUB_ENV
        echo "PYTHON_LIB_DIR=$PYTHON_LIB_DIR" >> $GITHUB_ENV

    - name: CMake Configure
      run: |
        cd opencv
        mkdir -p build && cd build
        cmake -G "MinGW Makefiles" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=install \
          -DOPENCV_EXTRA_MODULES_PATH=../../opencv_contrib/modules \
          -DWITH_GSTREAMER=ON \
          -DWITH_FFMPEG=OFF \
          -DWITH_QT=OFF \
          -DWITH_OPENGL=OFF \
          -DBUILD_opencv_world=ON \
          -DBUILD_opencv_python3=ON \
          -DBUILD_EXAMPLES=OFF \
          -DBUILD_TESTS=OFF \
          -DBUILD_PERF_TESTS=OFF \
          -DBUILD_JAVA=OFF \
          -DWITH_IPP=OFF \
          -DWITH_CUDA=OFF \
          -DCMAKE_C_COMPILER=gcc \
          -DCMAKE_CXX_COMPILER=g++ \
          -DCMAKE_CXX_FLAGS="-Wa,-mbig-obj" \
          -DCMAKE_C_FLAGS="-Wa,-mbig-obj" \
          -DPYTHON3_EXECUTABLE="$PYTHON_EXEC" \
          -DPYTHON3_INCLUDE_DIR="$PYTHON_INC" \
          -DPYTHON3_PACKAGES_PATH="$PYTHON_LIB_DIR" \
          ..

    - name: Build OpenCV
      run: |
        cd opencv/build
        mingw32-make -j3 || exit 1

    - name: Install OpenCV
      run: |
        cd opencv/build
        mingw32-make install
        echo "Install directory contents:"
        ls -la ../install || true

    - name: Package
      run: |
        mkdir -p opencv/artifacts
        cp -r opencv/install/* opencv/artifacts/ || echo "Warning: No files in install/"
        cd opencv
        zip -r opencv-gstreamer-mingw.zip artifacts/

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: opencv-gstreamer-mingw-build
        path: opencv/opencv-gstreamer-mingw.zip
        retention-days: 30
