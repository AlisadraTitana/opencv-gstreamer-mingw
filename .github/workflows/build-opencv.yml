name: Build OpenCV with GStreamer (Windows)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    env:
      OPENCV_VERSION: 4.10.0
      PYTHON_VERSION: 3.10
      GSTREAMER_VERSION: 1.22.8

    steps:
    # -----------------------------
    # Checkout
    # -----------------------------
    - name: Checkout
      uses: actions/checkout@v4

    # -----------------------------
    # Python
    # -----------------------------
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Python deps
      run: |
        python -m pip install --upgrade pip
        pip install numpy

    # -----------------------------
    # Install GStreamer (MSVC)
    # -----------------------------
    - name: Install GStreamer
      run: |
        curl -L -o gstreamer.msi https://gstreamer.freedesktop.org/data/pkg/windows/${{ env.GSTREAMER_VERSION }}/msvc/gstreamer-1.0-msvc-x86_64-${{ env.GSTREAMER_VERSION }}.msi
        curl -L -o gstreamer-dev.msi https://gstreamer.freedesktop.org/data/pkg/windows/${{ env.GSTREAMER_VERSION }}/msvc/gstreamer-1.0-devel-msvc-x86_64-${{ env.GSTREAMER_VERSION }}.msi
        msiexec /i gstreamer.msi /quiet /norestart
        msiexec /i gstreamer-dev.msi /quiet /norestart

    - name: Add GStreamer to PATH
      run: |
        echo "C:\gstreamer\1.0\msvc_x86_64\bin" >> $env:GITHUB_PATH

    # -----------------------------
    # Clone OpenCV
    # -----------------------------
    - name: Clone OpenCV
      run: |
        git clone https://github.com/opencv/opencv.git
        git clone https://github.com/opencv/opencv_contrib.git
        cd opencv
        git checkout ${{ env.OPENCV_VERSION }}
        cd ../opencv_contrib
        git checkout ${{ env.OPENCV_VERSION }}

    # -----------------------------
    # CMake Configure
    # -----------------------------
    - name: Configure OpenCV
      run: |
        mkdir opencv\build
        cd opencv\build
        cmake -G "Visual Studio 17 2022" -A x64 `
          -D CMAKE_BUILD_TYPE=Release `
          -D CMAKE_INSTALL_PREFIX=install `
          -D OPENCV_EXTRA_MODULES_PATH=..\..\opencv_contrib\modules `
          -D BUILD_opencv_python3=ON `
          -D PYTHON3_EXECUTABLE=$env:pythonLocation\python.exe `
          -D PYTHON3_INCLUDE_DIR=$env:pythonLocation\include `
          -D PYTHON3_PACKAGES_PATH=$env:pythonLocation\Lib\site-packages `
          -D WITH_GSTREAMER=ON `
          -D WITH_FFMPEG=ON `
          -D OPENCV_ENABLE_NONFREE=ON `
          -D BUILD_EXAMPLES=OFF `
          -D BUILD_TESTS=OFF `
          -D BUILD_PERF_TESTS=OFF `
          -D GSTREAMER_DIR="C:\gstreamer\1.0\msvc_x86_64" `
          ..

    # -----------------------------
    # Build & Install
    # -----------------------------
    - name: Build OpenCV
      run: |
        cd opencv\build
        cmake --build . --config Release --parallel

    - name: Install OpenCV
      run: |
        cd opencv\build
        cmake --install . --config Release

    # -----------------------------
    # Add cv2 to Python
    # -----------------------------
    - name: Install cv2 Python module
      run: |
        copy opencv\build\lib\Release\cv2.cp310-win_amd64.pyd $env:pythonLocation\Lib\site-packages\

    # -----------------------------
    # Verify
    # -----------------------------
    - name: Verify OpenCV + GStreamer
      run: |
        python - <<EOF
        import cv2
        print(cv2.__version__)
        print("GStreamer:", "YES" if "GStreamer" in cv2.getBuildInformation() else "NO")
        EOF
